# Harness Code Structure

This document maps repository layout to runtime responsibilities for maintainers and contributors.

## 1. Top-level layout

```text
harness/
  ARCHITECTURE.md
  PLAN.md
  README.md
  Cargo.toml
  docs/
    INSTALLATION.md
    CODE_STRUCTURE.md
    plans/
  scripts/
    install.sh
  src/
  tests/
```

## 2. Runtime crates/modules (`src/`)

### `src/main.rs`
- Binary entry point.
- Command dispatch orchestration.
- Top-level error handling and exit code mapping.

### `src/cli.rs`
- Clap definitions for all subcommands and flags.
- User input contract for CLI behavior.

### `src/error.rs`
- Shared error enum and conversion helpers used across command paths.

### `src/config.rs`
- Config file loading from global/repo/local layers.
- File IO and parse orchestration.

### `src/types/config.rs`
- Strongly typed config model.
- Validation of profile values, lifecycle fields, and metrics weights.

### `src/types/report.rs`
- Report payload structures used by renderers and command handlers.

### `src/types/scoring.rs`
- Scoring models, category score definitions, and related types.

### `src/scan/`
- `filesystem.rs`: repo file discovery and structure probing.
- `docs.rs`: docs/context presence checks.
- `tools.rs`: tool signatures and harness-related detection.
- `git_meta.rs`: git status and metadata signals.
- `mod.rs`: scan module wiring and shared structs.

### `src/analyze/`
- `context.rs`: context quality signals.
- `tools.rs`: toolset quality and policy-aligned checks.
- `continuity.rs`: continuity readiness scoring.
- `verification.rs`: verification/test-readiness signals.
- `quality.rs`: architecture/codebase quality checks.
- `lint.rs`: lint-facing conformance checks.
- `mod.rs`: analyzer coordination and output composition.

### `src/optimization/`
- `scoring.rs`: recommendation scoring transforms.
- `rules.rs`: optimization rules and thresholds.
- `recommender.rs`: recommendation generation and ranking.
- `presets.rs`: profile-based tuning defaults.
- `mod.rs`: module integration entry points.

### `src/generator/`
- `templates.rs`: text/template fragments for generated artifacts.
- `manifest.rs`: rollback/apply manifest structures and helpers.
- `writer.rs`: guarded filesystem writes and apply mechanics.
- `mod.rs`: plan/generator integration.

### `src/guardrails/`
- `command_policy.rs`: forbidden/disabled command policy enforcement.
- `loop_guard.rs`: loop/risk pattern checks.
- `mod.rs`: shared guardrail APIs.

### `src/trace/`
- `parser.rs`: trace input parsing.
- `aggregation.rs`: failure/runtime aggregation for optimization.
- `mod.rs`: trace module interfaces.

### `src/report/`
- `md.rs`: Markdown rendering.
- `json.rs`: JSON rendering.
- `sarif.rs`: SARIF rendering.
- `mod.rs`: format selection and renderer dispatch.

### `src/continuity.rs`
- Runtime continuity event logging support used by command flows.

## 3. Tests (`tests/`)

### `tests/cli_atdd.rs`
- End-to-end command scenarios.
- Positive and negative flow checks for CLI UX and guardrails.

### `tests/integration.rs`
- Cross-module integration behavior verification.

Additionally, unit tests are colocated within source modules under `src/`.

## 4. Data/control flow summary

1. CLI args parsed in `src/cli.rs`.
2. Config merged in `src/config.rs`.
3. Repository scanned via `src/scan/*`.
4. Signals analyzed in `src/analyze/*`.
5. Recommendations produced in `src/optimization/*`.
6. Output rendered by `src/report/*` or plan files generated by `src/generator/*`.
7. Apply path enforces guardrails via `src/guardrails/*` and rollback manifests.
8. Trace loop (`src/trace/*`) refines future optimization.

## 5. Where to implement common changes

### Add a new analysis rule
1. Add logic in relevant `src/analyze/*.rs`.
2. Extend score/report types in `src/types/*` if required.
3. Map result into optimizer in `src/optimization/*`.
4. Add unit tests and CLI ATDD regression coverage.

### Add a new CLI flag
1. Extend clap model in `src/cli.rs`.
2. Handle behavior in `src/main.rs`.
3. Add CLI tests in `tests/cli_atdd.rs`.

### Add a new report format
1. Create renderer in `src/report/`.
2. Wire selector in `src/report/mod.rs`.
3. Add integration/ATDD output checks.

## 6. Conventions

- Keep write operations isolated to generator/apply paths.
- Keep analyze/suggest read-only.
- Prefer deterministic ordering for output stability.
- Validate config aggressively and fail fast on malformed fields.
- Back every behavior change with tests (unit first, then CLI-level coverage).
